<html>
<head>
<title>data_clean.ipynb</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #bcbec4;}
.s1 { color: #cf8e6d;}
.s2 { color: #bcbec4;}
.s3 { color: #6aab73;}
.s4 { color: #7a7e85;}
.s5 { color: #2aacb8;}
.ls0 { height: 1px; border-width: 0; color: #43454a; background-color:#43454a}
</style>
</head>
<body bgcolor="#1e1f22">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#606060" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
data_clean.ipynb</font>
</center></td></tr></table>
<pre><span class="s0">#%% 
</span><span class="s1">import </span><span class="s0">pandas </span><span class="s1">as </span><span class="s0">pd</span>
<span class="s1">import </span><span class="s0">matplotlib</span><span class="s2">.</span><span class="s0">pyplot </span><span class="s1">as </span><span class="s0">plt</span>

<span class="s0">pd</span><span class="s2">.</span><span class="s0">set_option</span><span class="s2">(</span><span class="s3">'display.max_rows'</span><span class="s2">, </span><span class="s1">None</span><span class="s2">)</span><hr class="ls0"><span class="s0">#%% 
df_raw </span><span class="s2">= </span><span class="s0">pd</span><span class="s2">.</span><span class="s0">read_csv</span><span class="s2">(</span><span class="s3">&quot;data/apple_health_export_2025-11-22.csv&quot;</span><span class="s2">)</span><hr class="ls0"><span class="s0">#%% 
</span><span class="s4"># df_raw</span><hr class="ls0"><span class="s0">#%% 
df_raw</span><span class="s2">[</span><span class="s3">&quot;type&quot;</span><span class="s2">].</span><span class="s0">unique</span><span class="s2">()</span><hr class="ls0"><span class="s0">#%% 
df_raw</span><span class="s2">[</span><span class="s3">&quot;startDate&quot;</span><span class="s2">] = </span><span class="s0">pd</span><span class="s2">.</span><span class="s0">to_datetime</span><span class="s2">(</span><span class="s0">df_raw</span><span class="s2">[</span><span class="s3">&quot;startDate&quot;</span><span class="s2">])</span>
<span class="s0">df_raw</span><span class="s2">[</span><span class="s3">&quot;endDate&quot;</span><span class="s2">] = </span><span class="s0">pd</span><span class="s2">.</span><span class="s0">to_datetime</span><span class="s2">(</span><span class="s0">df_raw</span><span class="s2">[</span><span class="s3">&quot;endDate&quot;</span><span class="s2">])</span><hr class="ls0"><span class="s0">#%% 
df_raw</span><span class="s2">[</span><span class="s3">&quot;sourceName&quot;</span><span class="s2">].</span><span class="s0">unique</span><span class="s2">()</span><hr class="ls0"><span class="s0">#%% 
df_raw </span><span class="s2">= </span><span class="s0">df_raw</span><span class="s2">[</span><span class="s0">df_raw</span><span class="s2">[</span><span class="s3">&quot;sourceName&quot;</span><span class="s2">].</span><span class="s0">str</span><span class="s2">.</span><span class="s0">contains</span><span class="s2">(</span><span class="s3">&quot;Watch&quot;</span><span class="s2">, </span><span class="s0">na</span><span class="s2">=</span><span class="s1">False</span><span class="s2">)]</span>
<span class="s0">df_raw</span><hr class="ls0"><span class="s0">#%% md 
## Sleep <hr class="ls0">#%% 
df_sleep </span><span class="s2">= </span><span class="s0">df_raw</span><span class="s2">[</span><span class="s0">df_raw</span><span class="s2">[</span><span class="s3">&quot;type&quot;</span><span class="s2">] == </span><span class="s3">&quot;SleepAnalysis&quot;</span><span class="s2">]</span>
<span class="s4"># df_sleep = df_sleep[[&quot;value&quot;, &quot;startDate&quot;, &quot;endDate&quot;]]</span>
<span class="s0">df_sleep</span><hr class="ls0"><span class="s0">#%% 
</span><span class="s1">def </span><span class="s0">get_sleep_day</span><span class="s2">(</span><span class="s0">start</span><span class="s2">):</span>
    <span class="s4"># if sleep segment starts in the evening, count it for the next day</span>
    <span class="s1">if </span><span class="s0">start</span><span class="s2">.</span><span class="s0">hour </span><span class="s2">&gt;= </span><span class="s5">18</span><span class="s2">:</span>
        <span class="s1">return </span><span class="s2">(</span><span class="s0">start </span><span class="s2">+ </span><span class="s0">pd</span><span class="s2">.</span><span class="s0">Timedelta</span><span class="s2">(</span><span class="s0">days</span><span class="s2">=</span><span class="s5">1</span><span class="s2">)).</span><span class="s0">date</span><span class="s2">()</span>
    <span class="s1">else</span><span class="s2">:</span>
        <span class="s1">return </span><span class="s0">start</span><span class="s2">.</span><span class="s0">date</span><span class="s2">()</span><hr class="ls0"><span class="s0">#%% 
df_sleep</span><span class="s2">[</span><span class="s3">&quot;sleep_day&quot;</span><span class="s2">] = </span><span class="s0">df_sleep</span><span class="s2">[</span><span class="s3">&quot;startDate&quot;</span><span class="s2">].</span><span class="s0">apply</span><span class="s2">(</span><span class="s0">get_sleep_day</span><span class="s2">)</span><hr class="ls0"><span class="s0">#%% 
df_sleep</span><hr class="ls0"><span class="s0">#%% 
</span><span class="s4"># compute duration in minutes</span>
<span class="s0">df_sleep</span><span class="s2">[</span><span class="s3">&quot;duration&quot;</span><span class="s2">] = (</span><span class="s0">df_sleep</span><span class="s2">[</span><span class="s3">&quot;endDate&quot;</span><span class="s2">] - </span><span class="s0">df_sleep</span><span class="s2">[</span><span class="s3">&quot;startDate&quot;</span><span class="s2">])</span><span class="s4">#.dt.total_seconds()</span>
<span class="s4">#df_sleep[&quot;duration_min&quot;] = df_sleep[&quot;duration_sec&quot;] / 60</span><hr class="ls0"><span class="s0">#%% 
df_sleep</span><hr class="ls0"><span class="s0">#%% 
sleep_grouped </span><span class="s2">= </span><span class="s0">df_sleep</span><span class="s2">.</span><span class="s0">groupby</span><span class="s2">([</span><span class="s3">&quot;sleep_day&quot;</span><span class="s2">, </span><span class="s3">&quot;value&quot;</span><span class="s2">])[</span><span class="s3">&quot;duration&quot;</span><span class="s2">].</span><span class="s0">sum</span><span class="s2">().</span><span class="s0">reset_index</span><span class="s2">()</span>
<span class="s0">sleep_grouped</span><hr class="ls0"><span class="s0">#%% 
sleep_agg </span><span class="s2">= </span><span class="s0">sleep_grouped</span><span class="s2">.</span><span class="s0">pivot</span><span class="s2">(</span>
    <span class="s0">index</span><span class="s2">=</span><span class="s3">&quot;sleep_day&quot;</span><span class="s2">,</span>
    <span class="s0">columns</span><span class="s2">=</span><span class="s3">&quot;value&quot;</span><span class="s2">,</span>
    <span class="s0">values</span><span class="s2">=</span><span class="s3">&quot;duration&quot;</span>
<span class="s2">).</span><span class="s0">fillna</span><span class="s2">(</span><span class="s5">0</span><span class="s2">)</span>
<span class="s0">sleep_agg</span><hr class="ls0"><span class="s0">#%% 
sleep_agg</span><span class="s2">.</span><span class="s0">columns</span><hr class="ls0"><span class="s0">#%% 
sleep_agg</span><span class="s2">[</span><span class="s3">&quot;sleep_duration_sum&quot;</span><span class="s2">] = </span><span class="s0">sleep_agg</span><span class="s2">[</span><span class="s3">&quot;HKCategoryValueSleepAnalysisAsleepCore&quot;</span><span class="s2">] + </span><span class="s0">sleep_agg</span><span class="s2">[</span><span class="s3">&quot;HKCategoryValueSleepAnalysisAsleepDeep&quot;</span><span class="s2">] + </span><span class="s0">sleep_agg</span><span class="s2">[</span><span class="s3">&quot;HKCategoryValueSleepAnalysisAsleepREM&quot;</span><span class="s2">] + </span><span class="s0">sleep_agg</span><span class="s2">[</span><span class="s3">&quot;HKCategoryValueSleepAnalysisAwake&quot;</span><span class="s2">]</span>
<span class="s0">sleep_agg</span><hr class="ls0"><span class="s0">#%% 
sleep_agg</span><span class="s2">[</span><span class="s3">&quot;duration_min&quot;</span><span class="s2">] = </span><span class="s0">sleep_agg</span><span class="s2">[</span><span class="s3">&quot;sleep_duration_sum&quot;</span><span class="s2">] / </span><span class="s0">pd</span><span class="s2">.</span><span class="s0">Timedelta</span><span class="s2">(</span><span class="s0">minutes</span><span class="s2">=</span><span class="s5">1</span><span class="s2">)</span>
<span class="s0">sleep_agg</span><hr class="ls0"><span class="s0">#%% 
plt</span><span class="s2">.</span><span class="s0">hist</span><span class="s2">(</span><span class="s0">sleep_agg</span><span class="s2">[</span><span class="s3">&quot;duration_min&quot;</span><span class="s2">])</span><hr class="ls0"><span class="s0">#%% md 
## HRV <hr class="ls0">#%% 
df_hrv </span><span class="s2">= </span><span class="s0">df_raw</span><span class="s2">[</span><span class="s0">df_raw</span><span class="s2">[</span><span class="s3">&quot;type&quot;</span><span class="s2">] == </span><span class="s3">&quot;HeartRateVariabilitySDNN&quot;</span><span class="s2">]</span>
<span class="s0">df_hrv</span><hr class="ls0"><span class="s0">#%% 
</span><span class="s1">def </span><span class="s0">get_hrv_day</span><span class="s2">(</span><span class="s0">end</span><span class="s2">):</span>
        <span class="s1">return </span><span class="s0">end</span><span class="s2">.</span><span class="s0">date</span><span class="s2">()</span><hr class="ls0"><span class="s0">#%% 
df_hrv</span><span class="s2">[</span><span class="s3">&quot;hrv_day&quot;</span><span class="s2">] = </span><span class="s0">df_hrv</span><span class="s2">[</span><span class="s3">&quot;endDate&quot;</span><span class="s2">].</span><span class="s0">apply</span><span class="s2">(</span><span class="s0">get_hrv_day</span><span class="s2">)</span><hr class="ls0"><span class="s0">#%% 
df_hrv</span><hr class="ls0"><span class="s0">#%% 
df_hrv</span><span class="s2">[</span><span class="s3">&quot;value&quot;</span><span class="s2">] = </span><span class="s0">pd</span><span class="s2">.</span><span class="s0">to_numeric</span><span class="s2">(</span><span class="s0">df_hrv</span><span class="s2">[</span><span class="s3">&quot;value&quot;</span><span class="s2">], </span><span class="s0">errors</span><span class="s2">=</span><span class="s3">&quot;coerce&quot;</span><span class="s2">)</span><hr class="ls0"><span class="s0">#%% 
df_hrv</span><hr class="ls0"><span class="s0">#%% 
hrv_agg </span><span class="s2">= </span><span class="s0">df_hrv</span><span class="s2">.</span><span class="s0">groupby</span><span class="s2">([</span><span class="s3">&quot;hrv_day&quot;</span><span class="s2">])[</span><span class="s3">&quot;value&quot;</span><span class="s2">].</span><span class="s0">mean</span><span class="s2">().</span><span class="s0">reset_index</span><span class="s2">()</span>
<span class="s0">hrv_agg</span><hr class="ls0"><span class="s0">#%% 
hrv_agg </span><span class="s2">= </span><span class="s0">hrv_agg</span><span class="s2">.</span><span class="s0">rename</span><span class="s2">(</span><span class="s0">columns</span><span class="s2">={</span><span class="s3">&quot;value&quot;</span><span class="s2">: </span><span class="s3">&quot;mean_hrv&quot;</span><span class="s2">})</span><hr class="ls0"><span class="s0">#%% 
plt</span><span class="s2">.</span><span class="s0">hist</span><span class="s2">(</span><span class="s0">hrv_agg</span><span class="s2">[</span><span class="s3">&quot;mean_hrv&quot;</span><span class="s2">])</span><hr class="ls0"><span class="s0">#%% md 
## Merge Sleep und HRV Data <hr class="ls0">#%% 
df_all </span><span class="s2">= </span><span class="s0">pd</span><span class="s2">.</span><span class="s0">merge</span><span class="s2">(</span><span class="s0">sleep_agg</span><span class="s2">, </span><span class="s0">hrv_agg</span><span class="s2">, </span><span class="s0">left_on</span><span class="s2">=</span><span class="s3">&quot;sleep_day&quot;</span><span class="s2">, </span><span class="s0">right_on</span><span class="s2">=</span><span class="s3">&quot;hrv_day&quot;</span><span class="s2">, </span><span class="s0">how</span><span class="s2">=</span><span class="s3">&quot;left&quot;</span><span class="s2">)</span><hr class="ls0"><span class="s0">#%% 
df_all</span></pre>
</body>
</html>